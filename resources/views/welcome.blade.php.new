<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="csrf-token" content="{{ csrf_token() }}">

        <title>Virtual Tour</title>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.bunny.net">
        <link href="https://fonts.bunny.net/css?family=figtree:400,600&display=swap" rel="stylesheet" />

        <!-- Styles -->
        <style>
            /* Animations for coordinates */
            #displayPitch, #displayYaw {
                transition: opacity 0.15s ease-out;
            }
            
            .opacity-0 {
                opacity: 0;
            }
            
            /* Form hover effects */
            .btn-hover {
                transition: all 0.2s ease-out;
            }
            
            .btn-hover:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            /* Custom backgrounds */
            .bg-gradient-primary {
                background: linear-gradient(to right, var(--bs-primary), #0d6efd);
            }
            
            .bg-gradient-success {
                background: linear-gradient(to right, var(--bs-success), #20c997);
            }
            
            .bg-gradient-warning {
                background: linear-gradient(to right, var(--bs-warning), #ffc107);
            }
            
            .bg-gradient-danger {
                background: linear-gradient(to right, var(--bs-danger), #dc3545);
            }

            /* Dark mode */
            [data-bs-theme="dark"] {
                --bs-body-color: #dee2e6;
                --bs-body-bg: #212529;
            }

            [data-bs-theme="dark"] .card {
                --bs-card-bg: #2c3034;
            }

            /* Panorama viewer */
            #panorama {
                width: 100%;
                height: 400px;
                border-radius: 0.5rem;
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            }
        </style>
    </head>
    <body data-bs-theme="light">
        <div class="min-vh-100 bg-light">
            @if (Route::has('login'))
                <div class="position-fixed top-0 end-0 p-3">
                    @auth
                        <a href="{{ url('/home') }}" class="btn btn-outline-primary">Home</a>
                    @else
                        <a href="{{ route('login') }}" class="btn btn-outline-primary me-2">Log in</a>

                        @if (Route::has('register'))
                            <a href="{{ route('register') }}" class="btn btn-primary">Register</a>
                        @endif
                    @endauth
                </div>
            @endif

            <div class="container py-5">
                <div class="text-center mb-5">
                    <img src="{{ asset('images/logo.png') }}" alt="Logo" class="mb-4" style="height: 4rem;">
                </div>

                <div class="row mb-5">
                    <div class="col-12 text-center">
                        <h1 class="display-4 mb-4">Tour Virtual 360°</h1>
                        
                        <!-- Navigation buttons -->
                        <div class="d-flex justify-content-center gap-3 mb-5">
                            <a href="{{ route('hotspots.viewer') }}" 
                               class="btn btn-primary btn-lg btn-hover d-inline-flex align-items-center">
                                <i class="fas fa-eye me-2"></i>
                                <div class="text-start">
                                    <div>Visor 360°</div>
                                    <small class="opacity-75">Explorar el entorno</small>
                                </div>
                            </a>
                            
                            <a href="{{ route('hotspots.index') }}" 
                               class="btn btn-info btn-lg btn-hover d-inline-flex align-items-center">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                <div class="text-start">
                                    <div>Gestionar Puntos</div>
                                    <small class="opacity-75">Administrar hotspots</small>
                                </div>
                            </a>
                        </div>

                        <!-- Panorama Viewer -->
                        <div class="card shadow-lg mb-4">
                            <div class="card-body p-0">
                                <div id="panorama"></div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-center gap-2">
                                    <button id="addHotspotBtn" 
                                            class="btn btn-success btn-hover d-inline-flex align-items-center">
                                        <i class="fas fa-plus me-2"></i>
                                        <div class="text-start">
                                            <div>Agregar Punto</div>
                                            <small class="opacity-75">Crear nuevo hotspot</small>
                                        </div>
                                    </button>

                                    <button id="captureCoordinatesBtn" 
                                            class="btn btn-warning btn-hover d-none d-inline-flex align-items-center">
                                        <i class="fas fa-crosshairs me-2"></i>
                                        <div class="text-start">
                                            <div>Capturar</div>
                                            <small class="opacity-75">Coordenadas actuales</small>
                                        </div>
                                    </button>

                                    <button id="cancelHotspotBtn" 
                                            class="btn btn-secondary btn-hover d-none d-inline-flex align-items-center">
                                        <i class="fas fa-times me-2"></i>
                                        <div class="text-start">
                                            <div>Cancelar</div>
                                            <small class="opacity-75">Volver al tour</small>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Hotspot Form -->
                        <div id="hotspotFormContainer" class="card shadow d-none mx-auto" style="max-width: 500px;">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <h5 class="mb-0">Nuevo Punto de Interés</h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Coordinates Display -->
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Coordenadas Capturadas</strong>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="bg-light p-2 rounded">
                                                <small class="text-muted d-block">Vertical (Pitch)</small>
                                                <span class="font-monospace" id="displayPitch">-</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="bg-light p-2 rounded">
                                                <small class="text-muted d-block">Horizontal (Yaw)</small>
                                                <span class="font-monospace" id="displayYaw">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Fields -->
                                <div class="mb-3">
                                    <label for="hotspotTitle" class="form-label">
                                        <i class="fas fa-heading me-1"></i>
                                        Título del Punto
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </span>
                                        <input type="text" class="form-control" id="hotspotTitle" 
                                               placeholder="Ingresa un título descriptivo">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="hotspotText" class="form-label">
                                        <i class="fas fa-align-left me-1"></i>
                                        Descripción
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-pencil-alt"></i>
                                        </span>
                                        <textarea class="form-control" id="hotspotText" rows="3"
                                                  placeholder="Agrega una descripción detallada"></textarea>
                                    </div>
                                </div>

                                <input type="hidden" id="hotspotPitch">
                                <input type="hidden" id="hotspotYaw">

                                <!-- Form Actions -->
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" id="cancelFormBtn" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        Cancelar
                                    </button>
                                    <button type="button" id="saveHotspotBtn" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>
                                        Guardar Punto
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pannellum -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
        <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
        
        <script>
            // Utilidad para validar coordenadas
            function isValidCoordinates(pitch, yaw) {
                return typeof pitch === 'number' && 
                       typeof yaw === 'number' && 
                       !isNaN(pitch) && 
                       !isNaN(yaw) &&
                       pitch >= -90 && 
                       pitch <= 90 && 
                       yaw >= -180 && 
                       yaw <= 180;
            }

            // Utilidad para animar la actualización de coordenadas
            function updateCoordinatesDisplay(pitch, yaw) {
                const pitchDisplay = document.getElementById('displayPitch');
                const yawDisplay = document.getElementById('displayYaw');
                
                // Añadir clase para la animación
                pitchDisplay.classList.add('opacity-0');
                yawDisplay.classList.add('opacity-0');
                
                setTimeout(() => {
                    pitchDisplay.textContent = pitch.toFixed(2) + '°';
                    yawDisplay.textContent = yaw.toFixed(2) + '°';
                    
                    pitchDisplay.classList.remove('opacity-0');
                    yawDisplay.classList.remove('opacity-0');
                }, 150);
            }

            // Utilidad para mostrar/ocultar el form
            function toggleForm(show = true, coords = null) {
                const form = document.getElementById('hotspotFormContainer');
                
                if (show) {
                    if (coords) {
                        document.getElementById('hotspotPitch').value = coords.pitch.toFixed(2);
                        document.getElementById('hotspotYaw').value = coords.yaw.toFixed(2);
                        updateCoordinatesDisplay(coords.pitch, coords.yaw);
                    }
                    form.classList.remove('d-none');
                } else {
                    form.classList.add('d-none');
                }
            }

            // Variable global para el visor de Pannellum
            let viewer;
            let addingHotspot = false;
            
            // Función para cargar los hotspots desde la base de datos
            function loadHotspots() {
                return fetch('/hotspots-json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        return data;
                    })
                    .catch(error => {
                        console.error('Error cargando hotspots:', error);
                        return [];
                    });
            }
            
            // Inicializar el visor de Pannellum
            async function initPannellum() {
                // Intentar cargar hotspots desde la base de datos
                let hotspots = [];
                try {
                    hotspots = await loadHotspots();
                } catch (error) {
                    console.error('Error cargando hotspots:', error);
                    hotspots = [
                        {
                            "pitch": 14.1,
                            "yaw": 1.5,
                            "type": "info",
                            "text": "Punto de interés"
                        }
                    ];
                }
                
                // Crear el visor
                viewer = pannellum.viewer('panorama', {
                    "type": "equirectangular",
                    "panorama": "{{ asset('storage/360/lote360.jpeg') }}",
                    "autoLoad": true,
                    "autoRotate": -2,
                    "compass": true,
                    "hotSpots": hotspots
                });
                
                // Esperar a que el visor esté completamente cargado
                viewer.on('load', function() {
                    console.log('Visor Pannellum cargado correctamente');
                    
                    // Configurar múltiples eventos para capturar coordenadas
                    ['click', 'mousedown', 'mouseup'].forEach(eventType => {
                        viewer.on(eventType, function(event) {
                            if (addingHotspot && eventType === 'click') {
                                try {
                                    const coords = viewer.mouseEventToCoords(event);
                                    const [pitch, yaw] = coords;
                                    
                                    if (isValidCoordinates(pitch, yaw)) {
                                        toggleForm(true, { pitch, yaw });
                                        
                                        document.getElementById('cancelHotspotBtn').classList.remove('d-none');
                                        document.getElementById('addHotspotBtn').classList.add('d-none');
                                        
                                        addingHotspot = false;
                                        document.getElementById('panorama').style.cursor = 'default';
                                    } else {
                                        console.error('Coordenadas inválidas:', { pitch, yaw });
                                        alert('Error: No se pudieron obtener coordenadas válidas. Intenta de nuevo.');
                                    }
                                    
                                } catch (error) {
                                    console.error('Error obteniendo coordenadas:', error);
                                    alert('Error obteniendo coordenadas: ' + error.message);
                                }
                            }
                        });
                    });
                });
            }
            
            // Inicializar cuando el DOM esté listo
            document.addEventListener('DOMContentLoaded', function() {
                initPannellum();
                
                // Configurar el botón para activar el modo de agregar hotspot
                document.getElementById('addHotspotBtn').addEventListener('click', function() {
                    addingHotspot = true;
                    document.getElementById('panorama').style.cursor = 'crosshair';
                    document.getElementById('captureCoordinatesBtn').classList.remove('d-none');
                    
                    // Limpiar campos previos
                    document.getElementById('hotspotPitch').value = '';
                    document.getElementById('hotspotYaw').value = '';
                    
                    alert('Modo agregar hotspot activado.\n\nOpción 1: Haz clic en la imagen\nOpción 2: Usa el botón "Capturar Coordenadas Actuales"');
                });
                
                // Botón para captura manual de coordenadas
                document.getElementById('captureCoordinatesBtn').addEventListener('click', function() {
                    try {
                        const pitch = viewer.getPitch();
                        const yaw = viewer.getYaw();
                        
                        if (typeof pitch === 'number' && typeof yaw === 'number' && 
                            !isNaN(pitch) && !isNaN(yaw)) {
                            
                            // Guardar coordenadas
                            document.getElementById('hotspotPitch').value = pitch.toFixed(2);
                            document.getElementById('hotspotYaw').value = yaw.toFixed(2);
                            
                            // Actualizar indicadores visuales
                            document.getElementById('displayPitch').textContent = pitch.toFixed(2);
                            document.getElementById('displayYaw').textContent = yaw.toFixed(2);
                            
                            // Mostrar formulario
                            toggleForm(true);
                            document.getElementById('cancelHotspotBtn').classList.remove('d-none');
                            document.getElementById('addHotspotBtn').classList.add('d-none');
                            document.getElementById('captureCoordinatesBtn').classList.add('d-none');
                            
                            // Desactivar modo
                            addingHotspot = false;
                            document.getElementById('panorama').style.cursor = 'default';
                            
                            alert('¡Coordenadas capturadas exitosamente!\n\nPitch: ' + pitch.toFixed(2) + '°\nYaw: ' + yaw.toFixed(2) + '°\n\nCompleta el formulario para guardar el hotspot.');
                            
                        } else {
                            console.error('Coordenadas inválidas:', { pitch, yaw });
                            alert('Error: No se pudieron obtener coordenadas válidas del visor');
                        }
                    } catch (error) {
                        console.error('Error en captura manual:', error);
                        alert('Error al capturar coordenadas: ' + error.message);
                    }
                });
                
                // Configurar el botón para cancelar
                document.getElementById('cancelHotspotBtn').addEventListener('click', function() {
                    addingHotspot = false;
                    toggleForm(false);
                    document.getElementById('cancelHotspotBtn').classList.add('d-none');
                    document.getElementById('captureCoordinatesBtn').classList.add('d-none');
                    document.getElementById('addHotspotBtn').classList.remove('d-none');
                    document.getElementById('panorama').style.cursor = 'default';
                    
                    // Limpiar campos
                    document.getElementById('hotspotTitle').value = '';
                    document.getElementById('hotspotText').value = '';
                    document.getElementById('hotspotPitch').value = '';
                    document.getElementById('hotspotYaw').value = '';
                    
                    // Limpiar indicadores visuales
                    document.getElementById('displayPitch').textContent = '-';
                    document.getElementById('displayYaw').textContent = '-';
                });

                // Configurar el cancelar desde el form
                document.getElementById('cancelFormBtn').addEventListener('click', function() {
                    document.getElementById('cancelHotspotBtn').click();
                });
                
                // Configurar el botón para guardar el hotspot
                document.getElementById('saveHotspotBtn').addEventListener('click', function() {
                    const title = document.getElementById('hotspotTitle').value.trim();
                    const text = document.getElementById('hotspotText').value.trim();
                    const pitchValue = document.getElementById('hotspotPitch').value;
                    const yawValue = document.getElementById('hotspotYaw').value;
                    
                    // Validaciones básicas
                    if (!title || !text) {
                        alert('Por favor completa el título y la descripción');
                        return;
                    }
                    
                    if (!pitchValue || !yawValue || pitchValue === '' || yawValue === '') {
                        alert('Error: No se han capturado las coordenadas.\n\nPasos para solucionarlo:\n1. Haz clic en "Agregar Hotspot"\n2. Mueve la vista panorámica al punto deseado\n3. Haz clic en la imagen\n4. Completa este formulario');
                        return;
                    }
                    
                    const pitch = parseFloat(pitchValue);
                    const yaw = parseFloat(yawValue);
                    
                    // Validar que las coordenadas sean números válidos
                    if (isNaN(pitch) || isNaN(yaw)) {
                        alert('Error: Coordenadas inválidas. Intenta capturar las coordenadas de nuevo.');
                        return;
                    }
                    
                    // Validar rangos
                    if (pitch < -90 || pitch > 90) {
                        alert('El valor de Pitch debe estar entre -90° y 90°');
                        return;
                    }
                    
                    if (yaw < -180 || yaw > 180) {
                        alert('El valor de Yaw debe estar entre -180° y 180°');
                        return;
                    }
                    
                    // Crear el objeto hotspot
                    const hotspot = {
                        pitch: pitch,
                        yaw: yaw,
                        type: 'info',
                        title: title,
                        text: text
                    };
                    
                    // Enviar el hotspot al servidor mediante AJAX
                    fetch('/hotspots', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        },
                        body: JSON.stringify(hotspot)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Agregar el hotspot al visor
                            viewer.addHotSpot({
                                id: 'hotspot-' + Date.now(),
                                pitch: pitch,
                                yaw: yaw,
                                type: 'info',
                                text: title + ': ' + text
                            });
                            
                            // Limpiar y ocultar el formulario
                            document.getElementById('cancelHotspotBtn').click();
                            
                            alert('Hotspot agregado correctamente');
                        } else {
                            alert('Error: ' + (data.message || 'No se pudo crear el hotspot'));
                        }
                    })
                    .catch(error => {
                        console.error('Error guardando el hotspot:', error);
                        alert('Error al guardar el hotspot: ' + error.message);
                    });
                });
            });
        </script>
    </body>
</html>
